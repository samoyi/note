# Reactivity


<!-- TOC -->

- [Reactivity](#reactivity)
    - [设计目的](#设计目的)
    - [细节考虑](#细节考虑)
        - [绑定时需要考虑的问题](#绑定时需要考虑的问题)
        - [更新时需要考虑的问题](#更新时需要考虑的问题)
    - [设计模式](#设计模式)
    - [Vue 实现](#vue-实现)
        - [绑定时需要考虑的问题](#绑定时需要考虑的问题-1)
        - [更新时需要考虑的问题](#更新时需要考虑的问题-1)
    - [References](#references)

<!-- /TOC -->


## 设计目的
从 `./MVVM 框架解决的核心问题.md` 中的分析可以看出，响应式就要解决以下两大问题：
* 将一个或多个的 View 层 UI 节点绑定到 Model 层的一个数据上。（有时是绑定到多个数据计算出的一个数据上，也就是计算属性做的工作。这里统一理解为绑定到一个数据上。）
* Vue 侦听到参与绑定的数据发生变化时，使用新数据更新绑定到它身上的一个或多个节点。


## 细节考虑
### 绑定时需要考虑的问题
* 通过什么方式让一个节点和一个数据发生联系；
* 节点的更新方式有很多，比如更改文本、更改用时、更改内部子节点顺序等，绑定时怎么标记不同的更新方式；
* 在实际的代码中如何组织一个数据和绑定到它之上的节点；
* 怎么实现发布者和订阅者；
* 发布者和订阅者分别怎么与数据和节点建立关系；
* 订阅者怎么找到发布者；

### 更新时需要考虑的问题
* 怎么侦听数据更新；
* 对数据进行了写操作，但是值没变，这是是否不需要更新；
* 在短时间内对数据进行了多次修改，是否只需要用最后一次修改更新；（异步更新，防抖）
* 在实际的代码中怎么具体更新每个节点；


## 设计模式
明显的发布-订阅模式。


## Vue 实现
Vue 具体的实现原理和源码分析在 `../原理/Ovserver/` 目录下。下面简短的概括上面细节考虑中各个问题

### 绑定时需要考虑的问题
问题 | 解决
--|--
通过什么方式让一个节点和一个数据发生联系 | 在节点中插入 Vue 指令，指令的值就是要依赖的数据。
节点的更新方式有很多，比如更改文本、更改样式、更改内部子节点顺序等，绑定时怎么标记不同的更新方式 | 编译模板时会根据不同的指令编译为不同的渲染表达式
在实际的代码中如何组织一个数据和绑定到它之上的节点 | observe 数据时设置 getter，内部由当前数据 `dep` 实例的绑定逻辑；渲染表达式求值时触发 getter 进行绑定
怎么实现发布者和订阅者 | `Dep` 类和 `Watcher` 类
发布者和订阅者分别怎么与数据和节点建立关系 | `Dep` 实例被数据的 getter 和 setter 引用，`Watcher` 接收一个节点的更新表达式
订阅者怎么找到发布者 | 订阅者对更新表达式初次求值，访问其中依赖数据，触发依赖数据 getter，getter 中有发布者实例的绑定方法。这一过程中订阅者会暂时把自己放在全局可见的位置。
数组方法如何实现响应式

### 更新时需要考虑的问题
问题 | 解决
--|--
怎么侦听数据更新 | observe 数据时设置 setter
对数据进行了写操作，但是值没变，这是是否不需要更新 | setter 会判断值是否更新
在短时间内对数据进行了多次修改，是否只需要用最后一次修改更新 | 每轮事件循环一个数据的 `watcher` 只能加入一次异步更新队列
在实际的代码中怎么具体更新每个节点 | 节点的 `watcher` 有渲染表达式，依赖更新通知到 `watcher` 后调用渲染表达式更新渲染


## References

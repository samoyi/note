# Analyzing Critical Rendering Path Performance


## 没有 CSS 和 JS 的情况
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            </head>
            <body>
            <p>Hello</p>
            </body>
            </html>`);
        }, 200);
}
else {
    res.end()
}
```
![withoutCSSJS](./images/withoutCSSJS.png)

1. HTML 文件下载（末尾的蓝色部分）完成后，过了很短的时间，就发生了`DOMContentLoaded`,
即那条淡蓝色的竖线。
2. 也就是说文档刚下载完很快就完成了解析。
3. 之后在图片下载完成后，就发生了`load`，即红色的竖线。


## 加上 CSS 的情况
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            <link href="style.css" rel="stylesheet">
            </head>
            <body>
            <p>Hello</p>
            </body>
            </html>`);
        }, 200);
}
else if (req.url === '/style.css'){
    res.setHeader('content-type', 'text/css');
    setTimeout(()=>{
        res.end(`body{font-size: 2em;}`);
    }, 50);
}
else {
    res.end();
}
```
![withCSS](./images/withCSS.png)  
可以看到，CSS 文件的下载并没有阻塞 HTML 的解析，同样也是很快就`DOMContentLoaded`了


## 外部 JS 的情况
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            </head>
            <body>
            <p>Hello</p>
            <script src="script.js"></script>
            </body>
            </html>`);
        }, 200);
}
else if (req.url === '/script.js'){
    res.setHeader('content-type', 'text/javascript');
    setTimeout(()=>{
        res.end(`console.log('hello');
        for (let i=0; i<9999999; i++){
            Math.random();
        }`);
    }, 200);
}
else {
    res.end();
}
```
![withJS](./images/withJS.png)  
**外部** JS 的加载和执行都阻塞了 HTML 的解析，**即使是放在`body`尾部**

### 但外部 JS 并不会阻塞其他资源的加载
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            </head>
            <body>
            <p>Hello</p>
            <img src="https://www.baidu.com/img/bd_logo1.png?where=super" />
            <script src="script.js"></script>
            <img src="https://box.bdimg.com/static/fisp_static/common/img/searchbox/logo_news_276_88_1f9876a.png" />
            </body>
            </html>`);
        }, 200);
}
else if (req.url === '/script.js'){
    res.setHeader('content-type', 'text/javascript');
    setTimeout(()=>{
        res.end(`console.log('hello');
        for (let i=0; i<9; i++){
            Math.random();
        }`);
    }, 1000);
}
else {
    res.end();
}
```
![withJSImg](./images/withJSImg.png)  
也就是说，在这种情况，不管`<script>`放在那里都是一样的

## 行内 JS 的情况
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            </head>
            <body>
            <p>Hello</p>
            <script>
            for (let i=0; i<99999999; i++){
                Math.random();
            }
            </script>
            </body>
            </html>`);
        }, 200);
}
else {
    res.end();
}
```
![inlineJS](./images/inlineJS.png)  
行内 JS 和外部 JS 一样，同样会阻塞了 HTML 的解析，**即使是放在`body`尾部**

### 但是与外部 JS 正好相反，行内 JS 在任何地方都会阻塞其他资源的加载
```js
if (req.url === '/'){
    res.setHeader('content-type', 'text/html; charset=utf-8');
    setTimeout(()=>{
        res.end(`
            <!DOCTYPE html>
            <html>
            <head>
            <meta charset="utf-8">
            <title></title>
            </head>
            <body>
            <p>Hello</p>
            <img src="https://www.baidu.com/img/bd_logo1.png?where=super" />
            <img src="https://box.bdimg.com/static/fisp_static/common/img/searchbox/logo_news_276_88_1f9876a.png" />
            <script>
            for (let i=0; i<99999999; i++){
                Math.random();
            }
            </script>
            </body>
            </html>`);
        }, 200);
}
else {
    res.end();
}
```
![inlineJSImg](./images/inlineJSImg.png)


## 上述两种 JS 再加上 CSS 的情况

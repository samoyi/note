# 通用的图片浏览组件封装


<!-- TOC -->

- [通用的图片浏览组件封装](#通用的图片浏览组件封装)
    - [术语定义](#术语定义)
    - [支持的功能](#支持的功能)
    - [现状](#现状)
    - [模块结构](#模块结构)
    - [重构顺序](#重构顺序)
        - [第一步，基本看懂现有的逻辑](#第一步基本看懂现有的逻辑)
        - [第二步，整理现有代码](#第二步整理现有代码)
            - [便于拆分的情况](#便于拆分的情况)
        - [第三步，拆分](#第三步拆分)
    - [拆分组件要点](#拆分组件要点)
        - [拆分动机](#拆分动机)
        - [粒度和复用性](#粒度和复用性)
        - [组件依赖和副作用](#组件依赖和副作用)
        - [*小步修改* 重构原则](#小步修改-重构原则)
        - [组件 API](#组件-api)
            - [拆分前先分析组件接口](#拆分前先分析组件接口)
            - [API 类型和规范](#api-类型和规范)
            - [API 说明](#api-说明)
        - [基础组件](#基础组件)
        - [拆分子组件导致的 `this` 变化](#拆分子组件导致的-this-变化)
    - [涉及的重构方法](#涉及的重构方法)
        - [Extract Function](#extract-function)
        - [Extract Variable](#extract-variable)
        - [Change Function Declaration](#change-function-declaration)
        - [Encapsulate Variable](#encapsulate-variable)
        - [Rename Variable](#rename-variable)
        - [Split Phase](#split-phase)
        - [Hide Delegate](#hide-delegate)
        - [Move Function](#move-function)
        - [Consolidate Conditional Expression](#consolidate-conditional-expression)
        - [Remove Flag Argument](#remove-flag-argument)
        - [Split Parameter Object](#split-parameter-object)
    - [涉及的设计模式](#涉及的设计模式)
        - [中介者模式/享元模式](#中介者模式享元模式)
    - [性能优化](#性能优化)
        - [图片预加载](#图片预加载)
        - [区分 `v-show` 和 `v-if`](#区分-v-show-和-v-if)
    - [图片浏览组件使用方法](#图片浏览组件使用方法)
    - [References](#references)

<!-- /TOC -->


## 术语定义
* 组件：对应 `.vue` 文件
* 模块：实现一个独立功能的部分。一个组件会包含一个或多个模块。


## 支持的功能
* 图片拍摄信息展示
* 图片人脸识别
* 可拖动的图片列表缩略图列表
* 图片大图展示
* 图片操作：点赞、收藏、下载、转发


## 现状
* 当前的组件耦合于图片列表页
* 模块高度耦合
    * 组件本身的部分只有一个 `.vue` 文件，长达 2400 行，没有一行注释和文档。
    * 组件内的各个模块相互依赖，各模块的数据和方法在组件内全局可见，互相引用。导致在拆分的时候牵一发而动全身。
* 有很多大的方法


## 模块结构
* 完整组件
    * 结构头部
        * 显示的头部
            * 图片名称
            * 拍摄信息控件
            * 关闭按钮
        * 显示在主体部分的人脸识别结果（分类有问题，不属于结构头部）
    * 结构主体  
        * 显示的主体，即图片展示区域 
    * 结构底部     
        * 显示在主体部分的未分类部分（分类有问题，不属于结构底部）
            * 图片描述
            * 点赞控件（分类有问题，应该属于结构底部）
            * 下载提示
            * 浏览进度
        * 显示在主体部分的缩略图（分类有问题，不属于结构底部）
        * 显示的底部
            * 查看原图控件
            * 图片操作控件
                * 收藏控件
                * 下载控件
                * 转发控件
                * 管理控件


## 重构顺序
### 第一步，基本看懂现有的逻辑
1. 整理代码格式，写注释，写文档，构建模块结构图。
2. 本来一上来就准备先把大文件拆小，但由于不知道各模块之间的耦合关系，所以拆分的时候很容易出错。 

### 第二步，整理现有代码
#### 便于拆分的情况
* 纯函数。如果方法不直接引用当前组件的属性，那个拆分后就可以补改变方法的内部逻辑，只需要改变参数。
* scss 都是按照嵌套结构的，这样提取出一个模块后，可以快速找到这个模块的所有 scss。

### 第三步，拆分


## 拆分组件要点
### 拆分动机
1. 首先是为了降低复杂度和维护难度而进行拆分，其次才是为了复用而进行拆分。
2. 因为复用这种事情，其实是一个增加复杂度的场景，你要让一个东西兼容两个功能，肯定多少都会增加一些它的复杂度。
3. 因此应该先让组件变得简单易懂，然后才能更好的设计复用。

### 粒度和复用性
1. 整体的思想就是基于 SRP 和 OCP 的高内聚低耦合。但具体要有多内聚多耦合，还是要根据组件的复用情况来决定，而并不是简单的 SRP。
2. 根据复用需求和复用成两方面本来决定组件的粒度：如果一个部分可以在其他地方复用，并且复用时不会明显导致内部逻辑复杂，不会明显增大维护成本，那就可以实现为独立组件。

### 组件依赖和副作用
1. 根据可复用的范围来决定依赖的内容，权衡内聚和耦合：
    * 如果组件将来可被其他项目复用，那只能依赖 prop 和插槽；
    * 如果组件只会被当前项目全局复用，那还可以依赖 store 和 locaStorage 等；
    * 如果组件只用在图片浏览功能，还进一步还可以依赖 mixin。
2. 副作用的范围和依赖的相似：
    * 如果组件将来可被其他项目复用，那它不能有任何副作用；
    * 如果组件只会被当前项目全局复用，那还可以对 store 和 locaStorage 等有副作用；
    * 如果组件只用在图片浏览功能，还进一步还可以对 mixin 有副作用。

### *小步修改* 重构原则
1. 开始时各模块耦合度很高，拆分难度比较大。这样试图拆分出去的模块越大，就要处理越多的解耦和。
2. 因此可以先进行细粒度的拆分，拆分出很多小的组件，每次拆分只需要处理少量的解耦和。
3. 等到解耦完成后，再把可以合并的小组件进行合并以提高内聚性。
4. 而且，细粒度的拆分可以进行细粒度的测试，可以很快的定位拆分导致的错误。

### 组件 API
#### 拆分前先分析组件接口
1. 罗列出拆分后需要的 prop、自定义事件、插槽和 ref。
2. 确定哪些数据是要通过父级传入的、哪些是通过 mixin 使用的，哪些是全局共享的。
3. ref 引用的大部分其实可以转成 prop 加自定义事件。如果一定要直接操作 DOM，大多数也可以父级通过 prop 传递状态进去，然后子组件内部监听并自己操作 DOM。

#### API 类型和规范
1. 组件主要通过 prop、自定义事件和插槽者三类接口。
2. 其中，prop 的 `type` 属性提供参数的类型约束，`validator` 方法提供参数的值约束。
3. prop 的设计要考虑到 *Introduce Parameter Object* 和 *Split Parameter Object* 这两条重构规则的权衡。

#### API 说明
1. 一般情况下直接在组件中进行注释说明。主要包括以下三方面
    * prop
    * 自定义事件
    * 插槽
2. 因为 prop 都是统一放在 `props` 属性里，所以直接在相应的代码中加入注释；自定义事件和插槽并没有统一的位置，所以需要在组件头部统一进行说明。
3. 自定义事件的说明包括：事件名、触发条件和参数说明；插槽的说明包括插槽名、插槽内容、默认内容和作用域插槽的插槽 prop。
4. 示例
    ```html
    <!------------------------------------------------------------------------------------------------->
    <!--  # 查看大图按钮组件                                                                          -->
    <!--                                                                                             -->
    <!--  ## 自定义事件                                                                               -->
    <!--  ### `clickBtn`                                                                             -->
    <!--  * 点击时触发                                                                                -->
    <!--  * 包含一个参数为事件对象                                                                     -->
    <!--                                                                                             -->
    <!--  ## 插槽                                                                                    -->
    <!--  ### 默认插槽                                                                                -->
    <!--  * 插槽内容为按钮文字，默认值为 `查看大图`                                                     -->
    <!--                                                                                             -->
    <!--  ## 组件方法                                                                                 -->
    <!--  ### `$refs.click`                                                                          -->
    <!--  * 模拟按钮点击事件                                                                          -->
    <!------------------------------------------------------------------------------------------------->
    ```

### 基础组件
1. 由于公司没有公共组件库，而且当前项目的组件库也不完善，所以图片浏览部分的一些基础组件都是直接实现的。
2. 涉及的基础组件分为两类：当前项目可以公用的、其他 Vue 项目也可以公用的。
3. 现在对这些基础组件进行封装，以后如果构建公共组件库可以更方便的加入。
4. 当前项目可以公用的    
    * 查看大图按钮
    * 拍摄信息
        * 摄影师名称
        * 数码师名称
        * 拍摄时间
        * 拍摄地点
        * 照片名称 
    * 设备信息
        * 相机品牌
        * 相机型号
        * 镜头
        * 焦距
        * 光圈
        * 快门
        * ISO
        * 曝光
5. 其他 Vue 项目也可以公用的
    * 圆形头像
    * 关闭按钮
    * 信息按钮
    * 点赞按钮
    * 收藏按钮
    * 下载按钮
    * 分享按钮
6. 其中用到的图标为 iconfont 字体图标，其他项目要使用时需要先引入在线字体。

### 拆分子组件导致的 `this` 变化
1. 拆分出的子组件中用到的计算属性和方法都是定义在父组件上的，从父组件搬运过来的话，就是隔离在不同的组件作用域里面了。
2. 如果属性和方法适合放到 mixin 里面那就比较方便。否则的话，搬移到子组件之后，`this` 是指向子组件，会发生引用错误。
3. 如果在拆分的过程中就处理好所有的引用关系，那么本项重构的周期会比较长，需要处理好所有的计算属性和方法之后这个子组件才能使用，不符合小步修改的重构原则。
4. 可以直接让子组件直接引用父组件的计算属性和方法。办法是在子组件里定义同名的计算属性和方法，然后在内部引用父组件的计算属性和方法。例如
    ```js
    foo() {
        this.$parent.foo();
    }
    ```
5. 这样就可以快速的拆分出来一个可用的子组件，然后在此基础上逐个修改方法。
6. 这种思路的一个常见问题是，父组件中如果使用了 `$refs.someNode`，现在因为模板的搬移就访问不到了。
7. 我开始想到的解决方法是，在子组件调用父组件时绑定 `this`
    ```js
    foo() {
        this.$parent.foo.call(this);
    }
    ```
8. 但并没有用，发现 Vue 会使用 `bind` 方法把组件的方法绑定到当前组件实例上（源码中的 `initMethods` 方法）。而且居然即使我也使用 `bind` 绑定也不行
    ```js
    foo() {
        this.$parent.foo.bind(this)();
    }
    ```
9. 目前的解决方法只能改动父类中的方法，在其中通过 `$refs` 先引用到子组件再引用到对应的节点
    ```js
    this.$refs.child.$refs.someNode
    ```


## 涉及的重构方法
### Extract Function
1. 例如有一个 64 行的函数，用来初始化一个 Swiper 实例，其中 35 行都是在计算和组装参数对象，显然这部分应该提取出来。
2. 而且 35 行中还有 15 行在拼装模板字符串，模板字符串的格式和规则都根普通 JS 代码不同，看起来比较费劲，所以这部分也应该提取为独立的方法。

### Extract Variable
HTML 模板中不要写 JS 表达式，改为计算属性。

### Change Function Declaration

### Encapsulate Variable
* 拆分组件时公共数据放进 store，通过 getter 访问，通过 mutation 修改。
* 拆分组件时公共数据放进 mixin，通过计算属性访问，通过方法修改。

### Rename Variable

### Split Phase

### Hide Delegate
使用计算属性代替直接的 data 属性方法

### Move Function

### Consolidate Conditional Expression

### Remove Flag Argument
封装为不同的子函数

### Split Parameter Object
给子组件传 prop 时如果子组件只需要对象中的少部分属性，就不要传整个对象。


## 涉及的设计模式
### 中介者模式/享元模式
原来都在同一个组件里，现在拆分之后需要共享的数据和方法放进 mixin。


## 性能优化
### 图片预加载

### 区分 `v-show` 和 `v-if`
该用 `v-show` 的地方不要用 `v-if`。很多时候想用方便的 `v-else`，但如果只是显示隐藏而不是重渲染，那还是应该用 `v-show`


## 图片浏览组件使用方法
1. 模板中 `.yml` 文件配置图片浏览组件。
2. 需要进行浏览时先设置浏览的图片列表
    ```js
    this.$store.commit("photolist/setPicViewList", photosList);
    ```
3. 传入图片列表中的某个序号，开始图片浏览
    ```js
    // 例如这里从图片列表的第一张开始浏览
    this.$store.commit("photolist/openPicView", 0);
    ```


## References
* [揭秘 Vue.js 九个性能优化技巧](https://juejin.cn/post/6922641008106668045)
* [组件设计之道——张克军](https://pan.baidu.com/s/1PYqVhNL0ESRnc72IZLUSEQ)
* [Vuex、Flux、Redux、Redux-saga、Dva、MobX ](https://zhuanlan.zhihu.com/p/53599723)

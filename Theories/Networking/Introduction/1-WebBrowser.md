# 第 1 章　Web浏览器


<!-- TOC -->

- [第 1 章　Web浏览器](#第-1-章　web浏览器)
    - [生成 HTTP 请求消息](#生成-http-请求消息)
        - [URL 的类型](#url-的类型)
        - [浏览器解析 URL](#浏览器解析-url)
        - [生成 HTTP 请求消息](#生成-http-请求消息-1)
    - [向 DNS 服务器查询 Web 服务器的 IP 地址](#向-dns-服务器查询-web-服务器的-ip-地址)
        - [IP 地址的基本知识](#ip-地址的基本知识)
            - [TCP/IP 的基本思路](#tcpip-的基本思路)
            - [IP 地址的组成](#ip-地址的组成)
        - [Socket 库提供查询 IP 地址的功能](#socket-库提供查询-ip-地址的功能)
            - [解析器的内部原理](#解析器的内部原理)
    - [全世界 DNS 服务器的大接力](#全世界-dns-服务器的大接力)
        - [DNS 服务器的基本工作](#dns-服务器的基本工作)
        - [域名的层次结构](#域名的层次结构)
        - [寻找相应的 DNS 服务器并获取 IP 地址](#寻找相应的-dns-服务器并获取-ip-地址)
    - [References](#references)

<!-- /TOC -->


## 生成 HTTP 请求消息
### URL 的类型
1. 之所以有各种各样的 URL，是因为尽管我们通常是使用浏览器来访问 Web 服务器的，但实际上浏览器并不只有这一个功能，它也可以用来在 FTP 服务器上下载和上传文件，同时也具备电子邮件客户端的功能。
2. 可以说，浏览器是一个具备多种客户端功能的综合性客户端软件，因此它需要一些东西来判断应该使用其中哪种功能来访问相应的数据，而各种不同的 URL 就是用来干这个的。
3. 下图列举了现在互联网中常见的几种 URL，根据访问目标的不同，URL 的写法也会不同
    <img src="./images/03.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />

### 浏览器解析 URL
1. 浏览器要做的第一步工作就是对 URL 进行解析，从而生成发送给 Web 服务器的请求消息。刚才我们已经讲过，URL 的格式会随着协议的不同而不同，因此下面我们以访问 Web 服务器的情况为例来进行讲解
    <img src="./images/04.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
2. 根据 HTTP 的规格，URL 包含上图（a）中的这几种元素。当对 URL 进行解析时，首先需要按照上图（a）的格式将其中的各个元素拆分出来。
3. 例如上图（b）中的 URL 会拆分成（c）的样子。然后，通过拆分出来的这些元素，我们就能够明白 URL 代表的含义。

### 生成 HTTP 请求消息
1. 对 URL 进行解析之后，浏览器确定了 Web 服务器和文件名，接下来就是根据这些信息来生成 HTTP 请求消息了。
2. 实际上，HTTP 消息在格式上是有严格规定的，因此浏览器会按照规定的格式来生成请求消息
    <img src="./images/05.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />


## 向 DNS 服务器查询 Web 服务器的 IP 地址
### IP 地址的基本知识
1. 生成 HTTP 消息之后，接下来我们需要委托操作系统将消息发送给 Web 服务器。
2. 尽管浏览器能够解析网址并生成 HTTP 消息，但它本身并不具备将消息发送到网络中的功能，因此这一功能需要委托操作系统来实现。发送消息的功能对于所有的应用程序来说都是通用的，因此让操作系统来实现这一功能，其他应用程序委托操作系统来进行操作，这是一个比较合理的做法。
3. 在进行这一操作时，我们还有一个工作需要完成，那就是查询网址中服务器域名对应的 IP 地址。在委托操作系统发送消息时，必须要提供的不是通信对象的域名，而是它的 IP 地址。
4. 因此，在生成 HTTP 消息之后，下一个步骤就是根据域名查询 IP 地址。

#### TCP/IP 的基本思路
1. 互联网和公司内部的局域网都是基于 TCP/IP 的思路来设计的，所以我们先来了解 TCP/IP 的基本思路。
2. TCP/IP 的结构如下图所示，就是由一些小的子网，通过路由器连接起来组成一个大的网络
    <img src="./images/06.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
3. 这里的子网可以理解为用集线器连接起来的几台计算机，我们将它看作一个单位，称为 **子网**。当计算机数量较少时，可以用一台集线器连接起来；当计算机数量较多时，一台集线器可能无法连接这么多计算机，可以增加集线器数量并将集线器相互连接起来，这时，凡是通过集线器连接起来的所有设备都属于同一个子网。
4. 将子网通过路由器连接起来，就形成了一个网络（一些家用路由器中已经内置了集线器功能，因此大家可以理解为这种路由器内部同时包含路由器和集线器两种设备，它们在里面已经连接起来了）。
5. 在网络中，所有的设备都会被分配一个 IP 地址，由 **网络号** 和 **主机号** 两部分组成。网络号是分配个整个子网的，而主机号是分配给子网中的计算机的。通过 IP 地址我们可以判断出访问对象服务器的位置，从而将消息发送到服务器。
6. 发送者发出的消息首先经过子网中的集线器，转发到距离发送者最近的路由器上（上图 ①）。接下来，路由器会根据消息的目的地判断下一个路由器的位置，然后将消息发送到下一个路由器，即消息再次经过子网内的集线器被转发到下一个路由器（上图 ②）。这个过程不断重复，最终消息就被传送到了目的地。

#### IP 地址的组成
1. 如下图所示，实际的 IP 地址是一串 32 比特的数字，按照 8 比特（1 字节）为一组分成 4 组，分别用十进制表示然后再用圆点隔开
    <img src="./images/07.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
2. 这就是我们平常经常见到的 IP 地址格式，但仅凭这一串数字我们无法区分哪部分是网络号，哪部分是主机号。在 IP 地址的规则中，网络号和主机号连起来总共是 32 比特，但这两部分的具体结构是不固定的。在组建网络时，用户可以自行决定它们之间的分配关系，因此，我们还需要另外的附加信息来表示 IP 地址的内部结构。
3. 这一附加信息称为 **子网掩码**，是一串与 IP 地址长度相同的 32 比特数字，其左边部分都是 1，右边部分都是 0。其中，子网掩码为 1 的部分对应 IP 地址中的网络号，子网掩码为 0 的部分对应 IP 地址中的主机号
    <img src="./images/08.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
4. 将子网掩码按照和 IP 地址一样的方式以每 8 比特为单位用圆点分组后写在 IP 地址的右侧，这就是上上图（b）的方法。这种写法太长，我们也可以把 1 的部分的比特数用十进制表示并写在 IP 地址的右侧，如上上图（c） 所示。这两种方式只是写法上的区别，含义是完全一样的。
5. 子网掩码表示网络号与主机号之间的边界。在本例中，这个边界与字节的边界是正好吻合的，也就是正好划分在句点的位置上，实际上也可以划分在字节的中间位置。
6. 顺带一提，主机号部分的比特全部为 0 或者全部为 1 时代表两种特殊的含义。主机号部分全部为 0 代表整个子网而不是子网中的某台设备（上上图（d））。此外，主机号部分全部为 1 代表向子网上所有设备发送包，即广播（上上图（e））。

### Socket 库提供查询 IP 地址的功能
1. 向 DNS 服务器发出查询，也就是向 DNS 服务器发送查询消息，并接收服务器返回的响应消息。换句话说，对于 DNS 服务器，我们的计算机上一定有相应的 DNS 客户端。
2. 相当于 DNS 客户端的部分称为 **DNS 解析器**，或者简称解析器。通过 DNS 查询 IP 地址的操作称为 **域名解析**，因此负责执行解析（resolution）这一操作的就叫解析器（resolver）了。
3. 解析器实际上是一段程序，它包含在操作系统的 **Socket 库** 中，其中包含的程序组件可以让其他的应用程序调用操作系统的网络功能，而解析器就是这个库中的其中一种程序组件。
4. 解析器的用法非常简单。Socket 库中的程序都是标准组件，只要从应用程序中进行调用就可以了。具体来说，在编写浏览器等应用程序的时候，只要像下图这样写上解析器的程序名称 “gethostbyname” 以及 Web 服务器的域名 “www.lab.glasscom.com” 就可以了，这样就完成了对解析器的调用
    <img src="./images/09.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
5. 调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。
6. 接下来，浏览器在向 Web 服务器发送消息时，只要从该内存地址取出 IP 地址，并将它与 HTTP 请求消息一起交给操作系统就可以了。

#### 解析器的内部原理
1. 下面来看一看当应用程序调用解析器时，解析器内部是怎样工作的。网络应用程序（在我们的场景中就是指浏览器）调用解析器时，程序的控制流程就会转移到解析器的内部
    <img src="./images/10.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
2. 一般来说，应用程序编写的操作内容是从上往下按顺序执行的，当到达需要调用解析器的部分时，对应的那一行程序就会被执行，应用程序本身的工作就会暂停（上图 ①）。然后，Socket 库中的解析器开始运行（上图 ②），完成应用程序委托的操作。
3. 当控制流程转移到解析器后，解析器会生成要发送给 DNS 服务器的查询消息。这个过程与浏览器生成要发送给 Web 服务器的 HTTP 请求消息的过程类似，解析器会根据 DNS 的规格，生成一条表示 “请告诉我 www.lab.glasscom.com 的 IP 地址” 的数据，准备将它发送给 DNS 服务器。
4. 发送消息这个操作并不是由解析器自身来执行，而是要委托给操作系统内部的协议栈来执行（上图 ③）。这是因为和浏览器一样，解析器本身也不具备使用网络收发数据的功能。
5. 协议栈是操作系统内部的网络控制软件，也叫 “协议驱动”、“TCP/IP 驱动” 等。解析器调用协议栈后，控制流程会再次转移，协议栈会执行发送消息的操作，然后通过网卡将消息发送给 DNS 服务器（上图 ④⑤）。
6. 当 DNS 服务器收到查询消息后，它会根据消息中的查询内容进行查询。如果要访问的 Web 服务器已经在 DNS 服务器上注册，那么这条记录就能够被找到，然后其 IP 地址会被写入响应消息并返回给客户端（上图 ⑥）。
7. 接下来，消息经过网络到达客户端，再经过协议栈被传递给解析器（上图 ⑦⑧），然后解析器读取出消息取出 IP 地址，写入应用程序指定的内存地址中（上图 ⑨）。
8. 到这里，解析器的工作就完成了，控制流程重新回到应用程序（浏览器），现在应用程序已经能够从内存中取出 IP 地址了。
9. 顺带一提，向 DNS 服务器发送消息时，我们当然也需要知道 DNS 服务器的 IP 地址。只不过这个 IP 地址是作为 TCP/IP 的一个设置项目事先设置好的，不需要再去查询了。


## 全世界 DNS 服务器的大接力
### DNS 服务器的基本工作
1. 前文介绍了解析器与 DNS 服务器之间的交互过程，下面来了解一下 DNS 服务器的工作。DNS 服务器的基本工作就是接收来自客户端的查询消息，然后根据消息的内容返回响应。
2. 其中，来自客户端的查询消息包含以下 3 种信息。
    * **域名**。服务器、邮件服务器（邮件地址中 `@` 后面的部分）的名称。
    * **Class**。在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN。
    * **记录类型**。表示域名对应何种类型的记录。例如，当类型为 A 时，表示域名对应的是 IP 地址；当类型为 MX 时，表示域名对应的是邮件服务器。对于不同的记录类型，服务器向客户端返回的信息也会不同。
3. DNS 服务器上事先保存有前面这 3 种信息对应的记录数据，DNS 服务器就是根据这些记录查找符合查询请求的内容并对客户端作出响应的
    <img src="./images/11.png" width="600" style="display: block; margin: 5px 0 10px; border: 10px solid #fff" />
4. 例如，如果要查询 www.lab.glasscom.com 这个域名对应的 IP 地址，客户端会向 DNS 服务器发送包含以下信息的查询消息
    * 域名 = www.lab.glasscom.com
    * Class = IN
    * 记录类型 = A

### 域名的层次结构
1. 在前面的讲解中，我们假设要查询的信息已经保存在 DNS 服务器内部的记录中了。如果是在像公司内部网络这样 Web 和邮件服务器数量有限的环境中，所有的信息都可以保存在一台 DNS 服务器中，其工作方式也就完全符合我们前面讲解的内容。
2. 然而，互联网中存在着不计其数的服务器，将这些服务器的信息全部保存在一台 DNS 服务器中是不可能的，因此一定会出现在 DNS 服务器中找不到要查询的信息的情况。下面来看一看此时 DNS 服务器是如何工作的。
3. 我们先来看一看信息是如何在 DNS 服务器上注册并保存的。
4. 首先，DNS 服务器中的所有信息都是按照域名以分层次的结构来保存的。DNS 中的域名都是用句点来分隔的，比如 www.lab.glasscom.com，这里的句点代表了不同层次之间的界限。
5. 相当于一个层级的部分称为 **域**。因此，com 域的下一层是 glasscom 域，再下一层是 lab 域，再下面才是 www 这个名字。
6. 这种具有层次结构的域名信息会注册到 DNS 服务器中，而每个域都是作为一个整体来处理的。换句话说就是，一个域的信息是作为一个整体存放在 DNS 服务器中的，不能将一个域拆开来存放在多台 DNS 服务器中。
7. 不过，DNS 服务器和域之间的关系也并不总是一对一的，一台 DNS 服务器中也可以存放多个域的信息。为了避免把事情搞得太复杂，这里先假设一台 DNS 服务器中只存放一个域的信息，后面的讲解也是基于这个前提来进行的。
8. 于是，DNS 服务器也具有了像域名一样的层次结构，每个域的信息都存放在相应层级的 DNS 服务器中。

### 寻找相应的 DNS 服务器并获取 IP 地址



## References
* [网络是怎样连接的](https://book.douban.com/subject/26941639/)
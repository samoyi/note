# 前端埋点改进方案


<!-- TOC -->

- [前端埋点改进方案](#前端埋点改进方案)
    - [环境](#环境)
    - [之前的状态——直接的命令式埋点](#之前的状态直接的命令式埋点)
    - [改进思路——Vue 自定义指令](#改进思路vue-自定义指令)
    - [References](#references)

<!-- /TOC -->


## 环境
* Vue SPA
* 神策 Web JS SDK


## 之前的状态——直接的命令式埋点
1. 在 store 里封装了公共的上报方法
    ```js
    actions: {
        async trackEvent () {
            // 调用神策接口
        },
    }
    ```
2. 各个 UI 组件里调用该方法在具体的事件里设置埋点
    ```js
    methods: {
        onClickShareBtn () {
            // 处理分享相关逻辑
            // ...

            // 调用封装的上报方法
            this.$store.dispatch('sensors/trackEvent', {
                eventName: 'myEventName',
                data: {
                    clickType: 'share'
                }
            });
        },
    }
    ```



## 改进思路——Vue 自定义指令
1. 之前就一直感觉不爽，但也没有时间修改。最近看到装饰者模式一个关于把埋点方法分离出业务方法的例子，正好实践一下。
2. 但是，因为组件里会有很多不同的事件处理，如果使用装饰者模式包装的话，就会需要包装很多方法。
3. 这样虽然做到了 SRP，但是确实是很麻烦。
4. 不过，还好 Vue.js 提供了自定义指令这种很方便的声明式 DOM 操作方法。
5. 这里为每种 DOM 事件定义一个埋点指令，例如这个点击事件的指令
    ```js
    // 调用 store 中封装的方法发送数据
    const track = (event, key, value) => {
        store.dispatch("sensors/trackEvent", {
            eventName: event,
            data: {
                [key]: value,
            }
        });
    };

    export default Vue => {
        Vue.directive('track-click', {
            // 元素插入父级时绑定点击事件，并记录该指令接收的事件名、属性名和属性值
            inserted (el, {value: {event, key, value}}) {
                el.trackClickHander = ()=>{
                    track(event, key, value);
                };
                el.addEventListener('click', el.trackClickHander);
            },
            // 元素移除时解绑事件
            unbind (el) {
                el.removeEventListener('click', el.trackClickHander);
            }
        });
    };
    ```
6. 使用的时候传入定义好的事件名、属性名和属性值即可。
    ```html
    <span @click="onClickShareBtn" 
        v-track-click="{
            event: 'myEventName', 
            key: 'clickType', 
            value: 'share'
        }"
    >
        去分享
    </span>
    ```


## References
* [基于指令和混合的前端通用埋点方案](https://zhuanlan.zhihu.com/p/27659302)

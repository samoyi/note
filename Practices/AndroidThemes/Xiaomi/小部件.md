# 小部件


<!-- TOC -->

- [小部件](#小部件)
    - [TODO](#todo)
    - [设计规范](#设计规范)
        - [坐标](#坐标)
        - [功能运用](#功能运用)
    - [var_config.xml](#var_configxml)
        - [`<item>`](#item)
        - [自定义颜色组](#自定义颜色组)
        - [滑动条](#滑动条)
        - [自定义对齐方式](#自定义对齐方式)
        - [自定义样式 - 图片位](#自定义样式---图片位)
        - [设定时间](#设定时间)
            - [重复](#重复)
            - [使用](#使用)
        - [开关](#开关)
    - [Demos](#demos)
        - [运动计步](#运动计步)

<!-- /TOC -->


## TODO
* 桌面是否为5x6布局 是啥



## 设计规范
### 坐标
1. 制作时没有根据 UI 进行缩放的，需要使用全局变量来写小部件位置，不可直接写固定坐标。
2. 原因是桌面布局，图标尺寸，图标大小，无障碍视觉大小，搜索框，虚拟按键等功能会影响小部件尺寸，若写了固定位置元素有可能被裁切。

### 功能运用
直接看 [文档](https://zmsto9sfpq.feishu.cn/docx/doxcndMGffgwu1b5tQyDP5V77sf#doxcnk4MUCCkuukcSisHckppR4b)


## var_config.xml
1. 作用是支持用户对小部件的内容进行自定义。
2. manifest.xml 中只是用来展示的，第一次先从 manifest.xml 读取内容来展示。如果修改的话，则修改的部分会保存在 var_config.xml 中，之后就是从 var_config.xml 读取内容来展示了。
3. 例如一个自定义文本，在 manifest.xml 如下定义
    ```xml
    <Var name="textContent" expression="'小米科技'" type="string" const="true" />

    <Text x="200" y="200" textExp="@textContent" />
    ```
4. 为了支持修改，需要在 var_config.xml 中定义一个相同 name 的 `<Text>`，对上面文本的自定义就会保存在这里，之后也会从这里读取
    ```xml
    <Text name="textContent" displayTitle="请输入自定义文字" editable="true" minLength="4" maxLength="8">
        <item>小米科技</item>
    </Text>
    ```
5. 如果 var_config.xml 中没有定义一个相同 name 的 `<Text>`，则进入编辑页面后，根本不会出现编辑的输入框；如果写了但是 `editable` 属性是 `false`，那么虽然会出现输入框，但是不可编辑。
6. `displayTitle` 是编辑时的提示文字；长度限制不区分全角半角。

### `<item>`
1. `<item>` 是用户编辑的可选项，例如在自定义颜色时，用户并不能输入颜色代码或者从色盘中选择任何颜色，而是只能从备选的几种颜色中选择。因此可以通过 `<item>` 来提供颜色选项
    ```xml
    <Color name="textColor" displayTitle="请选择字体颜色">
        <item>#000000</item>
        <item>#ff0000</item>
        <item>#ffff00</item>
        <item>#00ff00</item>
        <item>#0088ff</item>
        <item>#008800</item>
        <item>#007799</item>
        <item>#FFB6C1</item>
    </Color>
    ```
2. 至于自定义文本的情况，从上述原理上看，var_config.xml 中 `<Text>` 内部是不需要写 `<item>` 的，但为了防止可能出现的兼容问题，还是写上比较好。至于文档上说这里可以支持多个 `<item>`，就真的没有必要了。

### 自定义颜色组
1. 可以定义多组颜色，一组颜色是多个颜色的组合。例如下面在 var_config.xml 定义
    ```xml
    <ColorGroup name="colorStyle" displayTitle="配色样式" uiType="1">
        <Var name="color1" values="#0088ff,#ff0000,#ffff00,#00ff00,#0088ff" />
        <Var name="color2" values="#dddddd,#ff0088,#333333,#eeeeee,#555555" />
        <Var name="color3" values="#00ff00,#009900,#118822,#229922,#ff0088" />
    </ColorGroup>
    ```
2. 注意这里不是三组，而是五组。每一列的 `color1`、`color2`、`color2` 组成一组颜色。
3. 在 manifest.xml 使用如下
    ```xml
    <!-- 默认值 -->
    <Var name="color1" expression="'#0088ff'" type="string" const="true" />
    <Var name="color2" expression="'#dddddd'" type="string" const="true" />
    <Var name="color3" expression="'#00ff00'" type="string" const="true" />

    <Text color="@color1" x="#view_width/2" y="#view_height/2-100"  textExp="'小米主题'" />
    <Text color="@color2" x="#view_width/2" y="#view_height/2"  textExp="'小米主题'" />
    <Text color="@color3" x="#view_width/2" y="#view_height/2+100"  textExp="'小米主题'" />
    ```

### 滑动条
1. 可以在 var_config.xml 中定义一个数值范围，用户界面会作为一个滑动条。数值范围使用 `<FontSize>` 标签，但数值可用于任何地方，并不局限于字号
    ```xml
    <FontSize name="textSize" default="120" from="80" to="160" displayTitle="范围调节"/>
    ```
2. 然后在 manifest.xml 中使用
    ```xml
    <!-- 默认值 -->
    <Var name="textSize" expression="50" type="number" const="true"/>
    <Text x="#view_width/2" y="#view_height/2" size="#textSize" textExp="'小米主题'" />
    ```

### 自定义对齐方式
1. 其实就是一组数字，然后根据数字自己去设定对齐。
2. 当然你用这个数字做其他事情也可以，只不过在用户编辑时，选择数字的按钮是表示对齐的图标。
3. var_config.xml 中定义如下
    ```xml
    <Align name="alignMent" default="0" from="0" to="5" displayTitle="文字对其方式" />
    ```


### 自定义样式 - 图片位
1. 在 var_config.xml 中定义一组或多组可选的图片
    ```xml
    <ImageSelect name="image1" displayTitle="选择左侧图片" height="286" width="286" uiType="0">
        <item displayTitle="图片0">img_0.png</item>
        <item displayTitle="图片1">img_1.png</item>
        <item displayTitle="图片2">img_2.png</item>
        <item displayTitle="图片3">img_3.png</item>
    </ImageSelect>
    <ImageSelect name="image2" displayTitle="选择右侧图片" height="246" width="246" uiType="0">
        <item displayTitle="图片4">img_4.png</item>
        <item displayTitle="图片5">img_5.png</item>
        <item displayTitle="图片6">img_6.png</item>
    </ImageSelect>
    ```
2. 在 manifest.xml 中使用
    ```xml
    <Var name="image1" expression="'img_0.png'" type="string" const="true"/>
    <Var name="image2" expression="'img_4.png'" type="string" const="true"/>

    <Image x="100" y="#view_height/2" align="left" alignV="center" srcExp="@image1" />
    <Image x="#view_width-100" y="#view_height/2" align="right" alignV="center" srcExp="@image2" />
    ```

### 设定时间
#### 重复
1. 假设当前日期为 2023年7月18日星期二，设定日期为 2025年8月1日星期五。重复规则如下：
    * 如果默认不重复，则计算的是距离日期的直接天数，也就是 745 天；
    * 如果设定为每周重复，则计算距离下一个周五的天数，也就是 3 天；
    * 如果设定为每月重复，则计算距离下一个1号的天数，也就是 14 天；
    * 如果设定为每年重复，则计算距离下一个的8月1日的天数，同样是 14 天。
2. 假设当前日期还是 2023年7月18日星期二，但设定目标日期为 2025年7月7日星期一。则重复规则如下：
    * 如果默认不重复，则计算的是距离日期的直接天数，也就是 720 天；
    * 如果设定为每周重复，则计算距离下一个周一的天数，也就是 6 天；
    * 如果设定为每月重复，则计算距离下一7号的天数，也就是 20 天；
    * 如果设定为每年重复，则计算距离下一个的7月7日的天数，同样是 355 天。
3. 即使设定的日期是过去的时间，仍然可以继续重复。参考下面 `diffDate` 函数的计算规则。
4. `diffDate` 函数计算的是距离下一个目标日期的天数，因此它需要重复类型作为第三个参数。
5. 注意，如果设定的日期是已经过去的，例如设定日期为 2023年7月1日：
    * 此时如果不设置重复，则 `diffDate` 函数返回的就是一个负数，本例中就是 -17；
    * 但如果设置重复，则就是根据下一个目标日期天数来计算了，因此会返回一个正数；例如设置为每月重复，则计算的就是已经超过目标日期的 2023年8月1日，因此函数返回 14。

#### 使用
1. 在 var_config.xml 定义日期和重复类型两个变量，分别使用 `name` 属性和 `repeatVar` 属性
    ```xml
    <SetDate name="dateAA" default="2023-10-01" repeat="1" repeatVar="repeatAA" />
    ```
2. 在 manifest.xml 中使用
    ```xml
    <!-- 默认重复类型 -->
    <Var name="repeatAA" expression="0" type="number" const="true" />

    <!-- 默认时间 需要将日期转换为毫秒时间戳 -->
    <Var name="dateAA" expression="1696089600000" type="number" const="true" />

    <!-- 下一个目标日期是过去还是未来 -->
    <Var name="pastOrFuture"
        expression="ifelse(
            diffDate(#dateAA,#time_sys,#repeatAA) { 0 ** #repeatAA == 0,
            '已经过去',
            '还有'
        )"
        type="string"
    />
    <!-- 计算下一个目标日期  -->
    <Var name="nextTargetDate"
        expression="formatDate('yyyy年MM月dd号', 
                        diffDate(#dateAA, #time_sys, #repeatAA) * 86400000 + #time_sys
                    )"
        type="string" />

    <!-- 天数差值 距离目标日期天数 返回的是绝对值-->
    <!-- 如果设定的日期已经过去且没有设置重复，则颠倒前两个参数来返回绝对值 -->
    <!-- 如果设定的时间在未来，或者已经过去但设置了重复，则 diffDate 会返回正常的返回一个正数 -->
    <Var name="daysDifference"
        expression="ifelse(
            diffDate(#dateAA, #time_sys, #repeatAA) { 0 ** #repeatAA == 0,
            diffDate(#time_sys, #dateAA, 0),
            diffDate(#dateAA, #time_sys, #repeatAA)
        )"
        type="number" />

    <Rectangle x="0" y="0" w="#view_width" h="#view_height" fillColor="#000000" cornerRadius="0" />
    <Text x="50" y="60" alignV="center" color="#ffffff" size="36" textExp="@nextTargetDate" />
    <Text x="50" y="160" alignV="center" color="#ffffff" size="36"
        textExp="'距离选定日期' + @pastOrFuture + '' + #daysDifference + '天'" />
    ```

### 开关
1. 在 var_config.xml 定义
    ```xml
    <OnOff name="state1" default="1" displayTitle="显示文字"/>
    ```
2. 在 manifest.xml 中使用
    ```xml
    <!-- 默认值，一定要有，name为var_config.xml中OnOff标签的name -->
    <Var name="state1" expression="1" type="number" const="true" />

    <Text x="#view_width/2" y="#view_height/2" align="center" alignV="center" color="#ffffff"
        size="36" textExp="'小米主题'" visibility="#state1" />
    ```


## Demos
### 运动计步
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Widget version="2" frameRate="0" screenWidth="1080" useVariableUpdater="DateTime.Minute"
    dableCutRoundCorner="false">
    <ExternalCommands>
        <Trigger action="init,resume">
            <FunctionCommand target="fra" />
            <!-- ContentProvider接口在切屏时必须主动更新一次  -->
            <BinderCommand name="MiSteps" command="refresh" />
        </Trigger>
    </ExternalCommands>

    <!-- 动态调整帧率 参考文档中的帧率规则 -->
    <Group name="frameRateSetting">
        <Function name="fra">
            <IfCommand ifCondition="eqs(@isPreviewMode , 'true')">
                <Consequent>
                    <FrameRateCommand rate="10" />
                </Consequent>
                <Alternate>
                    <AnimationCommand target="frame" command="play" />
                </Alternate>
            </IfCommand>
        </Function>
        <FramerateController name="frame" initPause="true" loop="false">
            <ControlPoint frameRate="10" time="0" />
            <ControlPoint frameRate="10" time="800" />
            <ControlPoint frameRate="0" time="1000" />
        </FramerateController>
    </Group>

    <VariableBinders>
        <!-- 注意：不可卸载 小米健康App -->
        <ContentProviderBinder name="MiSteps"
            uri="content://com.mi.health.provider.main/activity/steps/brief"
            column="steps,goal,distance,energy,strength_duration,summary" countName="hasSteps">
            <!-- 当前步数 -->
            <Variable name="MiSteps_steps" type="string" column="steps" />
            <!-- 目标步数 -->
            <Variable name="MiSteps_goal" type="string" column="goal" />
            <!-- 距离 -->
            <Variable name="MiSteps_distance" type="string" column="distance" />
            <!-- 消耗卡路里（千卡） -->
            <Variable name="MiSteps_energy" type="string" column="energy" />
            <!-- 运动中高强度时长 -->
            <Variable name="MiSteps_strength_duration" type="string" column="strength_duration" />
            <!-- 运动是否达标 -->
            <Variable name="MiSteps_summary" type="string" column="summary" />
            <Trigger>
                <FunctionCommand target="fra" />
            </Trigger>
        </ContentProviderBinder>
    </VariableBinders>

    <Var name="title" type="string[]" const="true" expression="''"
        values="'当前步数：','目标步数：','距离：','消耗卡路里（千卡）：','运动中高强度时长：','运动是否达标：'" />
    <Var name="content" type="string[]" expression="''"
        values="@MiSteps_steps , @MiSteps_goal , preciseeval('@MiSteps_distance',2) , @MiSteps_energy , @MiSteps_strength_duration , @MiSteps_summary" />

    <!-- 视觉层 -->
    <Group>
        <Rectangle x="0" y="0" w="#view_width" h="#view_height" fillColor="#232323" cornerRadius="0" />
        <Array count="6" indexName="i">
            <Group y="#i*(#view_height/6)">
                <Rectangle x="0" y="(#view_height/6)/2" alignV="center" w="#view_width"
                    h="(#view_height/6)" fillColor="#ffffff" cornerRadius="0"
                    alpha="ifelse(!(#i%2),255*0.03,0)" />
                <Text x="40" y="(#view_height/6)/2" alignV="center" color="#ffffff" size="32"
                    textExp="@title[#i]+@content[#i]" fontFamily="mipro-light" alpha="255*0.7" />
            </Group>
        </Array>
    </Group>

    <!-- 打开APP,以下两个IntentCommand选择一个使用 -->
    <Button x="0" y="0" w="#view_width" h="#view_height">
        <Triggers>
            <Trigger action="up">
                <!-- 跳转到小米运动健康首页，兼容不同版本 -->
                <IntentCommand action="com.mi.health.action.ROUTER" package="com.mi.health" />
                <!--  跳转到小米运动健康-步数，兼容不同版本  -->
                <IntentCommand action="android.intent.action.VIEW"
                    uri="com.mi.health://localhost/d?action=steps&amp;origin=mithemelocksreen"
                    package="com.mi.health" />
            </Trigger>
        </Triggers>
    </Button>
</Widget>
```